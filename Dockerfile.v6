# A6 System v6.2.0 - Optimized Dockerfile (Build: 2025-12-05)
# 预下载所有模型和依赖,避免运行时下载

# ============================================
# Stage 1: 前端构建
# ============================================
FROM node:22-alpine AS frontend-builder

WORKDIR /app/chatroom_ui

# 1. 先复制package.json和lock文件 (利用Docker缓存)
COPY chatroom_ui/package.json chatroom_ui/pnpm-lock.yaml ./

# 2. 安装依赖
RUN npm install -g pnpm && pnpm install

# 3. 再复制其他源代码
COPY chatroom_ui/ ./

# 4. 构建
RUN pnpm run build

# ============================================
# Stage 2: Python基础镜像 + 系统依赖
# ============================================
FROM mcr.microsoft.com/playwright/python:v1.49.1-jammy AS base

# 设置环境变量
ENV PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Shanghai \
    PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# 安装额外系统依赖 (Playwright镜像已包含大部分依赖)
# 只需要安装: FFmpeg, Tesseract OCR, OpenCV依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ffmpeg \
    tesseract-ocr tesseract-ocr-eng tesseract-ocr-chi-sim tesseract-ocr-chi-tra \
    libtesseract-dev \
    libgl1-mesa-glx libglib2.0-0 \
    libsm6 libxext6 libxrender-dev libgomp1 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ============================================
# Stage 3: Python依赖安装
# ============================================
FROM base AS python-deps

WORKDIR /app

# 复制requirements.txt
COPY requirements.txt ./

# 安装Python依赖
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ============================================
# Stage 4: 模型和浏览器预下载
# ============================================
FROM python-deps AS models

WORKDIR /app

# 1. Playwright浏览器已包含在基础镜像中,无需额外安装

# 2. 预下载Whisper模型 (small)
RUN python3 -c "import whisper; whisper.load_model('small')"

# 3. 预下载OpenCV Haar Cascade模型
RUN python3 -c "import cv2; \
    cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml'); \
    cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_eye.xml')"

# 4. 验证所有依赖
RUN python3 -c "import playwright; import whisper; import cv2; print('All models loaded successfully!')"

# ============================================
# Stage 5: 最终镜像
# ============================================
FROM models AS final

WORKDIR /app

# 复制后端代码
COPY backend/app/ ./app/
COPY backend/main.py backend/admin_app.py ./
COPY config/ ./config/
COPY admin_ui/ ./admin_ui/

# 复制backend目录 (如果需要)
COPY backend/ ./backend/

# 从前端构建阶段复制静态文件
COPY --from=frontend-builder /app/chatroom_ui/dist ./chatroom_ui_dist

# 创建必要的目录
RUN mkdir -p /app/data /app/logs /app/uploads

# 暴露端口
EXPOSE 8888 8889

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8888/health || exit 1

# 启动脚本
COPY <<'EOF' /app/start.sh
#!/bin/bash
set -e

echo "=== M3 Agent System v6.0 Starting ==="
echo "Time: $(date)"
echo "Timezone: $TZ"

# 启动main.py (Agent API)
echo "Starting Agent API on port 8888..."
python3 main.py &
MAIN_PID=$!

# 等待main.py启动
sleep 5

# 启动admin_app.py (管理面板 + 聊天室)
echo "Starting Admin App on port 8889..."
python3 admin_app.py &
ADMIN_PID=$!

# 等待进程
echo "=== M3 Agent System v6.0 Started ==="
echo "Agent API: http://localhost:8888"
echo "Chat Room: http://localhost:8889"
echo "Admin Panel: http://localhost:8889/admin"

wait $MAIN_PID $ADMIN_PID
EOF

RUN chmod +x /app/start.sh

# 启动
CMD ["/app/start.sh"]
