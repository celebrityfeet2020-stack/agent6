<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent6 ç®¡ç†é¢æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #1a1a1a; color: #e5e5e5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        
        /* 2-2-2å¸ƒå±€ */
        .grid-2x2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-3x3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-full { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        
        .card { background: #2a2a2a; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #e5e5e5; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .status.running { background: #10b981; color: white; }
        .status.healthy { background: #10b981; color: white; }
        .status.degraded { background: #f59e0b; color: white; }
        .status.error { background: #ef4444; color: white; }
        .model-info { background: #1f1f1f; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .model-info p { margin: 5px 0; color: #999; font-size: 14px; }
        .model-info strong { color: #e5e5e5; }
        .badge { display: inline-block; padding: 3px 10px; background: #3b82f6; color: white; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover { background: #5568d3; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        button.small { padding: 5px 12px; font-size: 12px; }
        .tools-list { list-style: none; }
        .tools-list li { padding: 8px 0; border-bottom: 1px solid #3a3a3a; }
        .tools-list li:last-child { border-bottom: none; }
        .note { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 15px 0; border-radius: 4px; font-size: 14px; }
        .note.success { background: #d1fae5; border-left-color: #10b981; }
        .note.info { background: #dbeafe; border-left-color: #3b82f6; }
        
        /* æ€§èƒ½æŒ‡æ ‡æ ·å¼ */
        .perf-metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #3a3a3a; }
        .perf-metric:last-child { border-bottom: none; }
        .perf-label { color: #999; font-size: 14px; }
        .perf-value { color: #e5e5e5; font-size: 16px; font-weight: 600; }
        .perf-value.good { color: #10b981; }
        .perf-value.warning { color: #f59e0b; }
        .perf-value.error { color: #ef4444; }
        .perf-timestamp { color: #999; font-size: 12px; margin-top: 10px; text-align: right; }
        
        /* å¤§æ•°å­—å¡ç‰‡ */
        .big-number { text-align: center; padding: 20px; }
        .big-number .number { font-size: 48px; font-weight: 700; color: #667eea; margin: 10px 0; }
        .big-number .label { font-size: 14px; color: #999; }
        .big-number .sublabel { font-size: 12px; color: #999; margin-top: 5px; }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1024px) {
            .grid-3x3 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .grid-2x2, .grid-3x3 { grid-template-columns: 1fr; }
        }
        
        /* å…ƒæç¤ºè¯æ ·å¼ */
        .prompt-item { background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3a3a3a; }
        .prompt-item.active { border-left-color: #10b981; background: #1f3a2f; }
        .prompt-item h3 { font-size: 16px; margin-bottom: 8px; color: #e5e5e5; }
        .prompt-item .prompt-meta { font-size: 12px; color: #999; margin-bottom: 8px; }
        .prompt-item .prompt-content { font-size: 14px; color: #999; margin-bottom: 10px; white-space: pre-wrap; max-height: 100px; overflow-y: auto; background: #1f1f1f; padding: 10px; border-radius: 4px; }
        .prompt-item .prompt-actions { display: flex; gap: 5px; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: #2a2a2a; margin: 50px auto; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 20px; }
        .modal-content label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #e5e5e5; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; border: 1px solid #3a3a3a; border-radius: 6px; font-size: 14px; font-family: inherit; background: #1f1f1f; color: #e5e5e5; }
        .modal-content textarea { min-height: 150px; resize: vertical; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Agent6</h1>
            <p>æ™ºèƒ½å»¶è¿Ÿé¢„åŠ è½½ | å®šæ—¶å¥åº·æ£€æµ‹ | æ€§èƒ½ç›‘æ§ | å®æ—¶çŠ¶æ€æ±‡æŠ¥</p>
        </div>



        <!-- ç¬¬ä¸€è¡Œï¼šç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ (3ä¸ªå¡ç‰‡) -->
        <div class="grid-3x3">
            <!-- ç³»ç»Ÿè¿è¡Œæ—¶é—´ -->
            <div class="card">
                <div class="big-number">
                    <div class="label">ç³»ç»Ÿè¿è¡Œæ—¶é—´</div>
                    <div class="number" id="uptime-display">--</div>
                    <div class="sublabel" id="started-at">å¯åŠ¨æ—¶é—´: --</div>
                </div>
            </div>

            <!-- é¢„åŠ è½½çŠ¶æ€ -->
            <div class="card">
                <div class="big-number">
                    <div class="label">å†…å­˜é¢„åŠ è½½</div>
                    <div class="number" id="preload-status-icon">â³</div>
                    <div class="sublabel" id="preload-time">ç­‰å¾…ä¸­...</div>
                </div>
            </div>

            <!-- æ•´ä½“å¥åº·çŠ¶æ€ -->
            <div class="card">
                <div class="big-number">
                    <div class="label">æ•´ä½“å¥åº·çŠ¶æ€</div>
                    <div class="number" id="overall-health-icon">ğŸŸ¢</div>
                    <div class="sublabel" id="overall-health-text">å¥åº·</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šLLMåç«¯çŠ¶æ€ + Agent APIçŠ¶æ€ -->
        <div class="grid-2x2">
            <!-- LLM åç«¯çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ¤– LLM åç«¯çŠ¶æ€</h2>
                <span class="status running" id="llm-status">è¿è¡Œä¸­</span>
                <div class="model-info">
                    <p><strong>API åœ°å€:</strong> <span id="base-url" style="font-size: 12px;">åŠ è½½ä¸­...</span></p>
                    <p><strong>å½“å‰æ¨¡å‹:</strong> <span id="current-model">åŠ è½½ä¸­...</span></p>
                    <p><strong>å¯ç”¨æ¨¡å‹:</strong></p>
                    <ul id="available-models" class="tools-list" style="max-height: 150px; overflow-y: auto;">
                        <li>åŠ è½½ä¸­...</li>
                    </ul>
                </div>
                <button onclick="refreshLLMStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>

            <!-- Agent API çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ§  Agent API çŠ¶æ€</h2>
                <span class="status running">è¿è¡Œä¸­</span>
                <div class="model-info">
                    <p><strong>é…ç½®æ¨¡å‹:</strong> <span id="agent-model">åŠ è½½ä¸­...</span></p>
                    <p><strong>å·¥å…·æ•°é‡:</strong> <span id="tools-count">åŠ è½½ä¸­...</span></p>
                    <p><strong>API ç«¯å£:</strong> <span id="api-port">åŠ è½½ä¸­...</span></p>
                    <p><strong>æœ€åæ£€æµ‹:</strong> <span id="last-check-time">--</span></p>
                </div>
                <button onclick="triggerHealthCheck()" class="success">ğŸ” ç«‹å³æ£€æµ‹</button>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šæ¨¡å‹æ€§èƒ½ + APIæ€§èƒ½ + å†…å­˜çŠ¶æ€ -->
        <div class="grid-3x3">
            <!-- æ¨¡å‹æ€§èƒ½ -->
            <div class="card">
                <h2>âš¡ æ¨¡å‹æ€§èƒ½</h2>
                <div class="model-info">
                    <div class="perf-metric">
                        <span class="perf-label">Tokens/sï¼ˆååé‡ï¼‰</span>
                        <span class="perf-value good" id="tokens-per-second">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">TTFTï¼ˆé¦–tokenå»¶è¿Ÿï¼‰</span>
                        <span class="perf-value" id="ttft">-- ms</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">æ€»å»¶è¿Ÿ</span>
                        <span class="perf-value" id="total-latency">-- ms</span>
                    </div>
                    <div class="perf-timestamp" id="model-perf-updated">--</div>
                </div>
                <button onclick="triggerPerformanceTest()" class="success small">ğŸš€ ç«‹å³æµ‹è¯•</button>
            </div>

            <!-- API æ€§èƒ½ -->
            <div class="card">
                <h2>ğŸ“Š API æ€§èƒ½</h2>
                <div class="model-info">
                    <div class="perf-metric">
                        <span class="perf-label">å¹³å‡å“åº”æ—¶é—´</span>
                        <span class="perf-value" id="api-response-time">-- ms</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">è¯·æ±‚æ€»æ•°</span>
                        <span class="perf-value" id="total-requests">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">æˆåŠŸç‡</span>
                        <span class="perf-value good" id="success-rate">--%</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">æ¯å°æ—¶è¯·æ±‚æ•°</span>
                        <span class="perf-value" id="requests-per-hour">--</span>
                    </div>
                    <div class="perf-timestamp" id="api-perf-updated">--</div>
                </div>
            </div>

            <!-- å†…å­˜çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ’¾ å†…å­˜çŠ¶æ€</h2>
                <div class="model-info">
                    <div class="perf-metric">
                        <span class="perf-label">RSSå†…å­˜</span>
                        <span class="perf-value" id="memory-rss">-- MB</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">VMSå†…å­˜</span>
                        <span class="perf-value" id="memory-vms">-- MB</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">å†…å­˜å ç”¨ç‡</span>
                        <span class="perf-value" id="memory-percent">--%</span>
                    </div>
                    <div class="perf-timestamp" id="memory-updated">--</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬å››è¡Œï¼šå¥åº·æ£€æµ‹è¯¦æƒ… -->
        <div class="grid-full">
            <div class="card">
                <h2>ğŸ¥ å¥åº·æ£€æµ‹è¯¦æƒ…</h2>
                <div class="grid-2x2" style="margin-top: 15px;">
                    <div class="model-info">
                        <h3 style="margin-bottom: 10px;">ğŸ”§ å·¥å…·çŠ¶æ€</h3>
                        <div class="perf-metric">
                            <span class="perf-label">å¯ç”¨å·¥å…·æ•°</span>
                            <span class="perf-value" id="health-tools-count">--</span>
                        </div>
                        <div class="perf-metric">
                            <span class="perf-label">å·¥å…·çŠ¶æ€</span>
                            <span class="perf-value" id="health-tools-status">--</span>
                        </div>
                    </div>
                    <div class="model-info">
                        <h3 style="margin-bottom: 10px;">ğŸ”Œ APIçŠ¶æ€</h3>
                        <div class="perf-metric">
                            <span class="perf-label">Fleet API</span>
                            <span class="perf-value" id="health-fleet-api">--</span>
                        </div>
                        <div class="perf-metric">
                            <span class="perf-label">LangGraph API</span>
                            <span class="perf-value" id="health-langgraph-api">--</span>
                        </div>
                        <div class="perf-metric">
                            <span class="perf-label">LLMè¿æ¥</span>
                            <span class="perf-value" id="health-llm-connection">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬äº”è¡Œï¼šå…ƒæç¤ºè¯ç®¡ç† -->
        <div class="grid-full">
            <div class="card">
                <h2>ğŸ“ å…ƒæç¤ºè¯ç®¡ç† <span class="badge" id="active-prompt-badge">æ— æ¿€æ´»</span></h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="showCreatePromptModal()" class="success">â• åˆ›å»ºæ–°å…ƒæç¤ºè¯</button>
                    <button onclick="loadMetaPrompts()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                    <button onclick="deactivateAllPrompts()" class="danger">âŒ å–æ¶ˆæ¿€æ´»</button>
                </div>
                <div id="meta-prompts-list" style="max-height: 400px; overflow-y: auto;">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ç¬¬å…­è¡Œï¼šä¸Šä¸‹æ–‡ç›‘æ§ -->
        <div class="grid-full">
            <div class="card">
                <h2>ğŸ“Š ä¸Šä¸‹æ–‡ç›‘æ§</h2>
                <div id="context-monitor-content">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="loadContextMonitor()" class="small">ğŸ”„ åˆ·æ–°</button>
                    <button onclick="compressContext()" class="small" style="background: #f59e0b;">ğŸ—ƒï¸ å‹ç¼©ä¸Šä¸‹æ–‡</button>
                    <button onclick="resetContext()" class="danger small">ğŸ”„ é‡ç½®ä¸Šä¸‹æ–‡</button>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸ƒè¡Œï¼šç›‘æ§åŠŸèƒ½ -->
        <div class="grid-2x2">
            <!-- Fleetè®°å¿†ç»Ÿè®¡ -->
            <div class="card">
                <h2>ğŸ’¾ Fleetè®°å¿†åº“ç»Ÿè®¡</h2>
                <div id="fleet-stats-content">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
                <button onclick="loadFleetStats()" class="small">ğŸ”„ åˆ·æ–°</button>
            </div>
            
            <!-- å·¥å…·ä½¿ç”¨ç»Ÿè®¡ -->
            <div class="card">
                <h2>ğŸ› ï¸ å·¥å…·ä½¿ç”¨ç»Ÿè®¡</h2>
                <div id="tool-usage-chart" style="width: 100%; height: 350px;"></div>
                <button onclick="loadToolUsage()" class="small">ğŸ”„ åˆ·æ–°</button>
            </div>
        </div>

        <!-- ç¬¬ä¸ƒè¡Œï¼šå®æ—¶æ—¥å¿—æµ -->
        <div class="grid-full">
            <div class="card">
                <h2>ğŸ“œ å®æ—¶æ—¥å¿—æµ <span class="badge" id="log-status-badge" style="background: #999;">æœªè¿æ¥</span></h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="connectLogStream()" class="success small" id="connect-log-btn">â–¶ï¸ è¿æ¥</button>
                    <button onclick="disconnectLogStream()" class="danger small" id="disconnect-log-btn" disabled>â¸ï¸ æ–­å¼€</button>
                    <button onclick="clearLogs()" class="small">ğŸ—‘ï¸ æ¸…ç©º</button>
                    <label style="margin-left: 20px;">
                        <input type="checkbox" id="auto-scroll-checkbox" checked> è‡ªåŠ¨æ»šåŠ¨
                    </label>
                    <label style="margin-left: 10px;">
                        ç­›é€‰çº§åˆ«:
                        <select id="log-level-filter" onchange="filterLogs()">
                            <option value="ALL">å…¨éƒ¨</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                    </label>
                </div>
                <div id="log-container" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto; line-height: 1.6;">
                    <div style="color: #888;">ç‚¹å‡»â€œè¿æ¥â€æŒ‰é’®å¼€å§‹æ¥æ”¶å®æ—¶æ—¥å¿—...</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬å…«è¡Œï¼šå¯ç”¨å·¥å…·åˆ—è¡¨ -->
        <div class="grid-full">
            <div class="card">
                <h2>ğŸ› ï¸ å¯ç”¨å·¥å…· (<span id="tools-count-display">15</span>ä¸ª)</h2>
                <ul class="tools-list">
                    <li>âœ… <strong>Web Search</strong> - ç½‘é¡µæœç´¢ (DuckDuckGo)</li>
                    <li>âœ… <strong>Web Scraper</strong> - ç½‘é¡µæŠ“å– (BeautifulSoup4)</li>
                    <li>âœ… <strong>Browser Automation</strong> - æµè§ˆå™¨è‡ªåŠ¨åŒ– (Playwright)</li>
                    <li>âœ… <strong>Code Executor</strong> - ä»£ç æ‰§è¡Œ (Dockeræ²™ç›’)</li>
                    <li>âœ… <strong>File Operations</strong> - æ–‡ä»¶æ“ä½œ</li>
                    <li>âœ… <strong>Image OCR</strong> - å›¾åƒæ–‡å­—è¯†åˆ« (EasyOCR + Tesseract)</li>
                    <li>âœ… <strong>Image Analysis</strong> - å›¾åƒåˆ†æ</li>
                    <li>âœ… <strong>Data Analysis</strong> - æ•°æ®åˆ†æ (Pandas + Matplotlib)</li>
                    <li>âœ… <strong>SSH Tool</strong> - SSH è¿œç¨‹æ‰§è¡Œ</li>
                    <li>âœ… <strong>Git Tool</strong> - Git ä»“åº“ç®¡ç†</li>
                    <li>âœ… <strong>Universal API</strong> - é€šç”¨ API è°ƒç”¨</li>
                    <li>âœ… <strong>Telegram Tool</strong> - Telegram æœºå™¨äºº</li>
                    <li>âœ… <strong>Speech Recognition</strong> - è¯­éŸ³è¯†åˆ« (Whisper)</li>
                    <li>âœ… <strong>RPA Tool</strong> - RPAè‡ªåŠ¨åŒ–</li>
                    <li>âœ… <strong>File Sync</strong> - æ–‡ä»¶åŒæ­¥</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- å…ƒæç¤ºè¯åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">åˆ›å»ºæ–°å…ƒæç¤ºè¯</h2>
            <form id="promptForm" onsubmit="return false;">
                <input type="hidden" id="prompt-id" value="">
                
                <label for="prompt-name">åç§° *</label>
                <input type="text" id="prompt-name" required placeholder="ä¾‹å¦‚: ä¸“ä¸šPythonå¼€å‘åŠ©æ‰‹">
                
                <label for="prompt-content">å†…å®¹ *</label>
                <textarea id="prompt-content" required placeholder="è¾“å…¥å…ƒæç¤ºè¯å†…å®¹..."></textarea>
                
                <label for="prompt-tags">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                <input type="text" id="prompt-tags" placeholder="ä¾‹å¦‚: python,å¼€å‘,ä»£ç ">
                
                <label for="prompt-description">æè¿°</label>
                <textarea id="prompt-description" style="min-height: 80px;" placeholder="ç®€è¦æè¿°è¯¥å…ƒæç¤ºè¯çš„ç”¨é€”..."></textarea>
                
                <div class="modal-actions">
                    <button type="button" onclick="closePromptModal()">å–æ¶ˆ</button>
                    <button type="button" onclick="saveMetaPrompt()" class="success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // æ—¶é—´å¤„ç†å·¥å…·å‡½æ•°ï¼ˆä¿®å¤ï¼šç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
        // ============================================
        
        /**
         * å°†ISOæ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´æ˜¾ç¤º
         * @param {string} isoString - ISO 8601æ ¼å¼çš„æ—¶é—´å­—ç¬¦ä¸²
         * @returns {string} åŒ—äº¬æ—¶é—´æ ¼å¼åŒ–å­—ç¬¦ä¸²
         */
        function toBeijingTime(isoString) {
            if (!isoString) return '--';
            
            try {
                const date = new Date(isoString);
                
                // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
                const beijingTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
                
                // æ ¼å¼åŒ–ä¸º: 2024-12-05 12:30:45
                const year = beijingTime.getUTCFullYear();
                const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
                const day = String(beijingTime.getUTCDate()).padStart(2, '0');
                const hours = String(beijingTime.getUTCHours()).padStart(2, '0');
                const minutes = String(beijingTime.getUTCMinutes()).padStart(2, '0');
                const seconds = String(beijingTime.getUTCSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
                console.error('æ—¶é—´è½¬æ¢å¤±è´¥:', e);
                return isoString;
            }
        }
        
        /**
         * æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
         * @param {number} seconds - è¿è¡Œç§’æ•°
         * @returns {string} æ ¼å¼åŒ–çš„è¿è¡Œæ—¶é—´
         */
        function formatUptime(seconds) {
            if (!seconds) return '--';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (days > 0) {
                return `${days}å¤© ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
            } else if (hours > 0) {
                return `${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†é’Ÿ ${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }

        // ============================================
        // v6.0 Dashboard API é›†æˆ
        // ============================================
        
        /**
         * åŠ è½½ç³»ç»ŸçŠ¶æ€ï¼ˆv6.0æ–°APIï¼‰
         */
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/dashboard/system_status');
                const data = await response.json();
                
                // æ›´æ–°è¿è¡Œæ—¶é—´
                if (data.details && data.details.uptime_formatted) {
                    document.getElementById('uptime-display').textContent = data.details.uptime_formatted;
                }
                
                if (data.details && data.details.started_at) {
                    document.getElementById('started-at').textContent = `å¯åŠ¨æ—¶é—´: ${toBeijingTime(data.details.started_at)}`;
                }
                
                // æ›´æ–°æ•´ä½“å¥åº·çŠ¶æ€
                if (data.summary) {
                    const overall = data.summary.overall;
                    const healthIcon = document.getElementById('overall-health-icon');
                    const healthText = document.getElementById('overall-health-text');
                    
                    if (overall === 'healthy') {
                        healthIcon.textContent = 'ğŸŸ¢';
                        healthText.textContent = 'å¥åº·';
                        healthText.style.color = '#10b981';
                    } else if (overall === 'degraded') {
                        healthIcon.textContent = 'ğŸŸ¡';
                        healthText.textContent = 'é™çº§';
                        healthText.style.color = '#f59e0b';
                    } else {
                        healthIcon.textContent = 'ğŸ”´';
                        healthText.textContent = 'å¼‚å¸¸';
                        healthText.style.color = '#ef4444';
                    }
                    
                    // æ›´æ–°æœ€åæ£€æµ‹æ—¶é—´
                    if (data.summary.last_check) {
                        document.getElementById('last-check-time').textContent = toBeijingTime(data.summary.last_check);
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        /**
         * åŠ è½½é¢„åŠ è½½çŠ¶æ€
         */
        async function loadPreloadStatus() {
            try {
                const response = await fetch('/api/dashboard/preload-status');
                const data = await response.json();
                
                const icon = document.getElementById('preload-status-icon');
                const time = document.getElementById('preload-time');
                
                if (data.completed) {
                    icon.textContent = 'âœ…';
                    time.textContent = `å®Œæˆäº: ${toBeijingTime(data.preload_time)}`;
                    time.style.color = '#10b981';
                } else {
                    icon.textContent = 'â³';
                    time.textContent = 'ç­‰å¾…ä¸­... (T+15åˆ†é’Ÿ)';
                    time.style.color = '#f59e0b';
                }
                
            } catch (error) {
                console.error('åŠ è½½é¢„åŠ è½½çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        /**
         * åŠ è½½å¥åº·æ£€æµ‹ç»“æœ
         */
        async function loadHealthStatus() {
            try {
                const response = await fetch('/api/dashboard/health');
                const result = await response.json();
                
                if (result.status === 'pending') {
                    return; // è¿˜æœªæ‰§è¡Œé¦–æ¬¡æ£€æµ‹
                }
                
                const data = result.data;
                
                // æ›´æ–°å·¥å…·çŠ¶æ€
                if (data.tools) {
                    document.getElementById('health-tools-count').textContent = data.tools.count || '--';
                    document.getElementById('health-tools-status').textContent = data.tools.status === 'available' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨';
                }
                
                // æ›´æ–°APIçŠ¶æ€
                if (data.apis) {
                    document.getElementById('health-fleet-api').textContent = data.apis.fleet === 'available' ? 'âœ…' : 'âŒ';
                    document.getElementById('health-langgraph-api').textContent = data.apis.langgraph === 'available' ? 'âœ…' : 'âŒ';
                    
                    if (data.apis.llm) {
                        const llmStatus = data.apis.llm.status === 'connected' ? 'âœ… å·²è¿æ¥' : 'âŒ æ–­å¼€';
                        document.getElementById('health-llm-connection').textContent = llmStatus;
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½å¥åº·çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        /**
         * åŠ è½½æ€§èƒ½æµ‹è¯•ç»“æœ
         */
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/dashboard/performance');
                const result = await response.json();
                
                if (result.status === 'pending') {
                    return; // è¿˜æœªæ‰§è¡Œé¦–æ¬¡æµ‹è¯•
                }
                
                const data = result.data;
                
                // æ›´æ–°æ¨¡å‹æ€§èƒ½
                if (data.model_performance) {
                    const mp = data.model_performance;
                    document.getElementById('tokens-per-second').textContent = mp.tokens_per_second || '--';
                    document.getElementById('ttft').textContent = mp.ttft_ms ? `${mp.ttft_ms} ms` : '-- ms';
                    document.getElementById('total-latency').textContent = mp.total_latency_ms ? `${mp.total_latency_ms} ms` : '-- ms';
                    document.getElementById('model-perf-updated').textContent = `æ›´æ–°æ—¶é—´: ${toBeijingTime(data.timestamp)}`;
                }
                
                // æ›´æ–°å†…å­˜çŠ¶æ€
                if (data.memory_status) {
                    const mem = data.memory_status;
                    document.getElementById('memory-rss').textContent = mem.rss_mb ? `${mem.rss_mb} MB` : '-- MB';
                    document.getElementById('memory-vms').textContent = mem.vms_mb ? `${mem.vms_mb} MB` : '-- MB';
                    document.getElementById('memory-percent').textContent = mem.percent ? `${mem.percent}%` : '--%';
                    document.getElementById('memory-updated').textContent = `æ›´æ–°æ—¶é—´: ${toBeijingTime(data.timestamp)}`;
                }
                
            } catch (error) {
                console.error('åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        /**
         * åŠ è½½LLMåç«¯çŠ¶æ€ï¼ˆå…¼å®¹æ—§APIï¼‰
         */
        async function loadLLMStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // æ›´æ–° LLM åç«¯çŠ¶æ€
                if (data.llm_backend) {
                    document.getElementById('base-url').textContent = data.llm_backend.base_url;
                    document.getElementById('current-model').textContent = data.llm_backend.current_model;
                    
                    // æ›´æ–°å¯ç”¨æ¨¡å‹åˆ—è¡¨
                    const modelsUl = document.getElementById('available-models');
                    if (data.llm_backend.available_models && data.llm_backend.available_models.length > 0) {
                        modelsUl.innerHTML = data.llm_backend.available_models.map(model => `<li>${model}</li>`).join('');
                    } else {
                        modelsUl.innerHTML = '<li>æ— å¯ç”¨æ¨¡å‹</li>';
                    }
                }
                
                // æ›´æ–° Agent API çŠ¶æ€
                if (data.agent_api) {
                    document.getElementById('agent-model').textContent = data.agent_api.configured_model;
                    document.getElementById('tools-count').textContent = data.agent_api.tools_count;
                    document.getElementById('tools-count-display').textContent = data.agent_api.tools_count;
                    document.getElementById('api-port').textContent = data.agent_api.api_port;
                }
                
                // æ›´æ–°APIæ€§èƒ½ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                if (data.api_performance) {
                    const ap = data.api_performance;
                    document.getElementById('api-response-time').textContent = ap.average_response_time_ms ? `${ap.average_response_time_ms} ms` : '-- ms';
                    document.getElementById('total-requests').textContent = ap.total_requests || '--';
                    document.getElementById('success-rate').textContent = ap.success_rate ? `${ap.success_rate}%` : '--%';
                    document.getElementById('requests-per-hour').textContent = ap.requests_per_hour || '--';
                    
                    if (ap.last_updated) {
                        document.getElementById('api-perf-updated').textContent = `æ›´æ–°æ—¶é—´: ${toBeijingTime(ap.last_updated)}`;
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½LLMçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // ============================================
        // æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
        // ============================================
        
        /**
         * æ‰‹åŠ¨è§¦å‘å¥åº·æ£€æµ‹
         */
        async function triggerHealthCheck() {
            try {
                const response = await fetch('/api/dashboard/trigger-health-check', { method: 'POST' });
                const data = await response.json();
                alert('âœ… å¥åº·æ£€æµ‹å·²è§¦å‘ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœ');
                
                // 5ç§’ååˆ·æ–°æ•°æ®
                setTimeout(async () => {
                    await loadHealthStatus();
                    await loadSystemStatus();
                }, 5000);
            } catch (error) {
                alert('âŒ è§¦å‘å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * æ‰‹åŠ¨è§¦å‘æ€§èƒ½æµ‹è¯•
         */
        async function triggerPerformanceTest() {
            try {
                const response = await fetch('/api/dashboard/trigger-performance-test', { method: 'POST' });
                const data = await response.json();
                alert('âœ… æ€§èƒ½æµ‹è¯•å·²è§¦å‘ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœ');
                
                // 10ç§’ååˆ·æ–°æ•°æ®
                setTimeout(async () => {
                    await loadPerformanceData();
                }, 10000);
            } catch (error) {
                alert('âŒ è§¦å‘å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * åˆ·æ–°LLMçŠ¶æ€
         */
        async function refreshLLMStatus() {
            await loadLLMStatus();
            alert('âœ… çŠ¶æ€å·²åˆ·æ–°ï¼');
        }
        
        // ============================================
        // é¡µé¢åˆå§‹åŒ–
        // ============================================
        
        /**
         * åŠ è½½æ‰€æœ‰æ•°æ®
         */
        async function loadAllData() {
            await Promise.all([
                loadSystemStatus(),
                loadPreloadStatus(),
                loadHealthStatus(),
                loadPerformanceData(),
                loadLLMStatus()
            ]);
        }
        
        // ============================================
        // å…ƒæç¤ºè¯ç®¡ç†å‡½æ•°
        // ============================================
        
        /**
         * åŠ è½½å…ƒæç¤ºè¯åˆ—è¡¨
         */
        async function loadMetaPrompts() {
            try {
                const response = await fetch('/api/meta-prompts');
                const data = await response.json();
                
                const listContainer = document.getElementById('meta-prompts-list');
                
                if (!data.prompts || data.prompts.length === 0) {
                    listContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— å…ƒæç¤ºè¯ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»º</p>';
                    return;
                }
                
                let html = '';
                for (const prompt of data.prompts) {
                    const isActive = prompt.is_active;
                    const activeClass = isActive ? 'active' : '';
                    const activeTag = isActive ? '<span class="badge" style="background: #10b981;">å·²æ¿€æ´»</span>' : '';
                    
                    html += `
                        <div class="prompt-item ${activeClass}">
                            <h3>${prompt.name} ${activeTag}</h3>
                            <div class="prompt-meta">
                                <span>ID: ${prompt.id}</span> | 
                                <span>åˆ›å»º: ${toBeijingTime(prompt.created_at)}</span> | 
                                <span>ç‰ˆæœ¬: ${prompt.version}</span>
                                ${prompt.tags && prompt.tags.length > 0 ? ' | <span>æ ‡ç­¾: ' + prompt.tags.join(', ') + '</span>' : ''}
                            </div>
                            ${prompt.description ? '<div style="font-size: 13px; color: #888; margin-bottom: 8px;">' + prompt.description + '</div>' : ''}
                            <div class="prompt-content">${prompt.content}</div>
                            <div class="prompt-actions">
                                ${!isActive ? '<button class="small success" onclick="activatePrompt(\''+prompt.id+'\')">âœ… æ¿€æ´»</button>' : ''}
                                <button class="small" onclick="editPrompt(\''+prompt.id+'\')">âœï¸ ç¼–è¾‘</button>
                                <button class="small danger" onclick="deletePrompt(\''+prompt.id+'\')">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }
                
                listContainer.innerHTML = html;
                
                // æ›´æ–°æ¿€æ´»å¾½ç« 
                const activePrompt = data.prompts.find(p => p.is_active);
                const badge = document.getElementById('active-prompt-badge');
                if (activePrompt) {
                    badge.textContent = activePrompt.name;
                    badge.style.background = '#10b981';
                } else {
                    badge.textContent = 'æ— æ¿€æ´»';
                    badge.style.background = '#999';
                }
                
            } catch (error) {
                console.error('åŠ è½½å…ƒæç¤ºè¯å¤±è´¥:', error);
                document.getElementById('meta-prompts-list').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }
        
        /**
         * æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
         */
        function showCreatePromptModal() {
            document.getElementById('modal-title').textContent = 'åˆ›å»ºæ–°å…ƒæç¤ºè¯';
            document.getElementById('prompt-id').value = '';
            document.getElementById('prompt-name').value = '';
            document.getElementById('prompt-content').value = '';
            document.getElementById('prompt-tags').value = '';
            document.getElementById('prompt-description').value = '';
            document.getElementById('promptModal').style.display = 'block';
        }
        
        /**
         * ç¼–è¾‘å…ƒæç¤ºè¯
         */
        async function editPrompt(promptId) {
            try {
                const response = await fetch(`/api/meta-prompts/${promptId}`);
                const data = await response.json();
                
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘å…ƒæç¤ºè¯';
                document.getElementById('prompt-id').value = data.id;
                document.getElementById('prompt-name').value = data.name;
                document.getElementById('prompt-content').value = data.content;
                document.getElementById('prompt-tags').value = data.tags ? data.tags.join(',') : '';
                document.getElementById('prompt-description').value = data.description || '';
                document.getElementById('promptModal').style.display = 'block';
            } catch (error) {
                alert('åŠ è½½å…ƒæç¤ºè¯å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * å…³é—­æ¨¡æ€æ¡†
         */
        function closePromptModal() {
            document.getElementById('promptModal').style.display = 'none';
        }
        
        /**
         * ä¿å­˜å…ƒæç¤ºè¯
         */
        async function saveMetaPrompt() {
            const promptId = document.getElementById('prompt-id').value;
            const name = document.getElementById('prompt-name').value.trim();
            const content = document.getElementById('prompt-content').value.trim();
            const tags = document.getElementById('prompt-tags').value.trim();
            const description = document.getElementById('prompt-description').value.trim();
            
            if (!name || !content) {
                alert('åç§°å’Œå†…å®¹ä¸ºå¿…å¡«é¡¹');
                return;
            }
            
            const payload = {
                name,
                content,
                tags: tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [],
                description: description || null
            };
            
            try {
                let response;
                if (promptId) {
                    // æ›´æ–°
                    response = await fetch(`/api/meta-prompts/${promptId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                } else {
                    // åˆ›å»º
                    response = await fetch('/api/meta-prompts', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                }
                
                if (response.ok) {
                    closePromptModal();
                    await loadMetaPrompts();
                    alert('ä¿å­˜æˆåŠŸ!');
                } else {
                    const error = await response.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (error.detail || error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * æ¿€æ´»å…ƒæç¤ºè¯
         */
        async function activatePrompt(promptId) {
            try {
                const response = await fetch(`/api/meta-prompts/${promptId}/activate`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadMetaPrompts();
                    alert('æ¿€æ´»æˆåŠŸ!');
                } else {
                    const error = await response.json();
                    alert('æ¿€æ´»å¤±è´¥: ' + (error.detail || error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ¿€æ´»å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * å–æ¶ˆæ¿€æ´»æ‰€æœ‰å…ƒæç¤ºè¯
         */
        async function deactivateAllPrompts() {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ¿€æ´»æ‰€æœ‰å…ƒæç¤ºè¯å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/meta-prompts/deactivate', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadMetaPrompts();
                    alert('å·²å–æ¶ˆæ¿€æ´»');
                } else {
                    const error = await response.json();
                    alert('æ“ä½œå¤±è´¥: ' + (error.detail || error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * åˆ é™¤å…ƒæç¤ºè¯
         */
        async function deletePrompt(promptId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å…ƒæç¤ºè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/meta-prompts/${promptId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadMetaPrompts();
                    alert('åˆ é™¤æˆåŠŸ');
                } else {
                    const error = await response.json();
                    alert('åˆ é™¤å¤±è´¥: ' + (error.detail || error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // ============================================
        // å®æ—¶æ—¥å¿—æµç®¡ç†
        // ============================================
        
        let logWebSocket = null;
        let allLogs = [];  // å­˜å‚¨æ‰€æœ‰æ—¥å¿—
        
        /**
         * è¿æ¥æ—¥å¿—æµ
         */
        function connectLogStream() {
            if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
                alert('å·²ç»è¿æ¥äº†');
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/monitoring/logs/stream`;
            
            logWebSocket = new WebSocket(wsUrl);
            
            logWebSocket.onopen = function() {
                console.log('æ—¥å¿—æµå·²è¿æ¥');
                document.getElementById('log-status-badge').textContent = 'å·²è¿æ¥';
                document.getElementById('log-status-badge').style.background = '#10b981';
                document.getElementById('connect-log-btn').disabled = true;
                document.getElementById('disconnect-log-btn').disabled = false;
            };
            
            logWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'history') {
                    // å†å²æ—¥å¿—
                    allLogs = data.logs;
                    renderLogs();
                } else if (data.type === 'new_log') {
                    // æ–°æ—¥å¿—
                    allLogs.push(data.log);
                    // ä¿æŒæœ€å¤š1000æ¡
                    if (allLogs.length > 1000) {
                        allLogs.shift();
                    }
                    renderLogs();
                }
            };
            
            logWebSocket.onerror = function(error) {
                console.error('æ—¥å¿—æµé”™è¯¯:', error);
                document.getElementById('log-status-badge').textContent = 'é”™è¯¯';
                document.getElementById('log-status-badge').style.background = '#ef4444';
            };
            
            logWebSocket.onclose = function() {
                console.log('æ—¥å¿—æµå·²æ–­å¼€');
                document.getElementById('log-status-badge').textContent = 'æœªè¿æ¥';
                document.getElementById('log-status-badge').style.background = '#999';
                document.getElementById('connect-log-btn').disabled = false;
                document.getElementById('disconnect-log-btn').disabled = true;
            };
        }
        
        /**
         * æ–­å¼€æ—¥å¿—æµ
         */
        function disconnectLogStream() {
            if (logWebSocket) {
                logWebSocket.close();
                logWebSocket = null;
            }
        }
        
        /**
         * æ¸…ç©ºæ—¥å¿—
         */
        function clearLogs() {
            allLogs = [];
            document.getElementById('log-container').innerHTML = '<div style="color: #888;">æ—¥å¿—å·²æ¸…ç©º</div>';
        }
        
        /**
         * æ¸²æŸ“æ—¥å¿—
         */
        function renderLogs() {
            const container = document.getElementById('log-container');
            const levelFilter = document.getElementById('log-level-filter').value;
            
            // è¿‡æ»¤æ—¥å¿—
            let filteredLogs = allLogs;
            if (levelFilter !== 'ALL') {
                filteredLogs = allLogs.filter(log => log.level === levelFilter);
            }
            
            if (filteredLogs.length === 0) {
                container.innerHTML = '<div style="color: #888;">æš‚æ— æ—¥å¿—</div>';
                return;
            }
            
            // ç”ŸæˆHTML
            let html = '';
            for (const log of filteredLogs) {
                const time = new Date(log.timestamp).toLocaleTimeString('zh-CN', {hour12: false});
                let levelColor = '#d4d4d4';
                
                if (log.level === 'ERROR') {
                    levelColor = '#f48771';
                } else if (log.level === 'WARNING') {
                    levelColor = '#dcdcaa';
                } else if (log.level === 'INFO') {
                    levelColor = '#4ec9b0';
                }
                
                html += `<div style="margin-bottom: 5px;">`;
                html += `<span style="color: #858585;">[${time}]</span> `;
                html += `<span style="color: ${levelColor}; font-weight: bold;">[${log.level}]</span> `;
                if (log.source) {
                    html += `<span style="color: #569cd6;">[${log.source}]</span> `;
                }
                html += `<span>${log.message}</span>`;
                html += `</div>`;
            }
            
            container.innerHTML = html;
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (document.getElementById('auto-scroll-checkbox').checked) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        /**
         * è¿‡æ»¤æ—¥å¿—
         */
        function filterLogs() {
            renderLogs();
        }
        
        // ============================================
        // å·¥å…·ä½¿ç”¨ç»Ÿè®¡
        // ============================================
        
        let toolUsageChart = null;
        
        /**
         * åŠ è½½å·¥å…·ä½¿ç”¨ç»Ÿè®¡
         */
        async function loadToolUsage() {
            try {
                const response = await fetch('/api/monitoring/tools/usage');
                const data = await response.json();
                
                if (!toolUsageChart) {
                    toolUsageChart = echarts.init(document.getElementById('tool-usage-chart'));
                }
                
                // å‡†å¤‡æ•°æ®
                const toolNames = data.tools.map(t => t.tool_name);
                const usageCounts = data.tools.map(t => t.usage_count);
                
                // é…ç½®å›¾è¡¨
                const option = {
                    title: {
                        text: `æ€»è°ƒç”¨æ¬¡æ•°: ${data.summary.total_calls}`,
                        left: 'center',
                        textStyle: {
                            fontSize: 14,
                            color: '#666'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function(params) {
                            const item = params[0];
                            const tool = data.tools[item.dataIndex];
                            let html = `<strong>${tool.tool_name}</strong><br/>`;
                            html += `è°ƒç”¨æ¬¡æ•°: ${tool.usage_count}<br/>`;
                            if (tool.last_used) {
                                html += `æœ€åä½¿ç”¨: ${toBeijingTime(tool.last_used)}`;
                            }
                            return html;
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: toolNames,
                        axisLabel: {
                            rotate: 45,
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'è°ƒç”¨æ¬¡æ•°'
                    },
                    series: [
                        {
                            name: 'è°ƒç”¨æ¬¡æ•°',
                            type: 'bar',
                            data: usageCounts,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#667eea' },
                                    { offset: 1, color: '#764ba2' }
                                ])
                            },
                            emphasis: {
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#764ba2' },
                                        { offset: 1, color: '#667eea' }
                                    ])
                                }
                            }
                        }
                    ]
                };
                
                toolUsageChart.setOption(option);
                
            } catch (error) {
                console.error('åŠ è½½å·¥å…·ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // ============================================
        // Fleetè®°å¿†ç»Ÿè®¡
        // ============================================
        
        /**
         * åŠ è½½Fleetè®°å¿†ç»Ÿè®¡
         */
        async function loadFleetStats() {
            try {
                const response = await fetch('/api/monitoring/fleet/stats');
                const data = await response.json();
                
                const container = document.getElementById('fleet-stats-content');
                
                let html = '<div style="font-size: 14px;">';
                html += `<div class="perf-metric">`;
                html += `<span class="perf-label">æ€»è®°å¿†æ•°</span>`;
                html += `<span class="perf-value">${data.total_memories || 0}</span>`;
                html += `</div>`;
                
                html += `<div class="perf-metric">`;
                html += `<span class="perf-label">å·²åŒæ­¥</span>`;
                html += `<span class="perf-value good">${data.synced_memories || 0}</span>`;
                html += `</div>`;
                
                html += `<div class="perf-metric">`;
                html += `<span class="perf-label">æœªåŒæ­¥</span>`;
                html += `<span class="perf-value ${data.unsynced_memories > 0 ? 'warning' : ''}">${data.unsynced_memories || 0}</span>`;
                html += `</div>`;
                
                html += `<div class="perf-metric">`;
                html += `<span class="perf-label">å­˜å‚¨å¤§å°</span>`;
                html += `<span class="perf-value">${data.storage_size_mb || 0} MB</span>`;
                html += `</div>`;
                
                html += `<div class="perf-metric">`;
                html += `<span class="perf-label">å­˜å‚¨ä½¿ç”¨ç‡</span>`;
                const usagePercent = data.storage_usage_percent || 0;
                const usageClass = usagePercent > 80 ? 'error' : (usagePercent > 50 ? 'warning' : 'good');
                html += `<span class="perf-value ${usageClass}">${usagePercent}%</span>`;
                html += `</div>`;
                
                html += `<div class="perf-metric">`;
                html += `<span class="perf-label">å­˜å‚¨é™åˆ¶</span>`;
                html += `<span class="perf-value">${data.storage_limit_gb || 500} GB</span>`;
                html += `</div>`;
                
                if (data.storage_is_full) {
                    html += `<div class="note" style="background: #fee2e2; border-left-color: #ef4444; margin-top: 10px;">`;
                    html += `âš ï¸ å­˜å‚¨å·²æ»¡ï¼è¯·åŒæ­¥åˆ°Fleet APIååˆ é™¤æœ¬åœ°æ•°æ®ã€‚`;
                    html += `</div>`;
                }
                
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½Fleetç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('fleet-stats-content').innerHTML = 
                    '<p style="color: #ef4444; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }
        
        // ============================================
        // ä¸Šä¸‹æ–‡ç›‘æ§
        // ============================================
        
        /**
         * åŠ è½½ä¸Šä¸‹æ–‡ç›‘æ§
         */
        async function loadContextMonitor() {
            try {
                const response = await fetch('/api/context/threads');
                const data = await response.json();
                
                const container = document.getElementById('context-monitor-content');
                
                if (!data.threads || data.threads.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— æ´»è·ƒçº¿ç¨‹</p>';
                    return;
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';
                
                for (const thread of data.threads) {
                    const stats = thread.stats;
                    const statusClass = stats.status === 'critical' ? 'error' : (stats.status === 'warning' ? 'warning' : 'good');
                    
                    html += '<div style="background: #f9fafb; padding: 15px; border-radius: 8px; border-left: 4px solid ';
                    html += (stats.status === 'critical' ? '#ef4444' : (stats.status === 'warning' ? '#f59e0b' : '#10b981'));
                    html += ';">';
                    
                    html += `<div style="font-weight: 600; margin-bottom: 10px;">çº¿ç¨‹ID: ${thread.thread_id}</div>`;
                    
                    html += `<div class="perf-metric" style="padding: 5px 0;">`;
                    html += `<span class="perf-label">å½“å‰Token</span>`;
                    html += `<span class="perf-value ${statusClass}">${stats.current_tokens.toLocaleString()}</span>`;
                    html += `</div>`;
                    
                    html += `<div class="perf-metric" style="padding: 5px 0;">`;
                    html += `<span class="perf-label">ä½¿ç”¨ç‡</span>`;
                    html += `<span class="perf-value ${statusClass}">${stats.usage_percent.toFixed(1)}%</span>`;
                    html += `</div>`;
                    
                    html += `<div class="perf-metric" style="padding: 5px 0;">`;
                    html += `<span class="perf-label">æ¶ˆæ¯æ•°</span>`;
                    html += `<span class="perf-value">${stats.message_count}</span>`;
                    html += `</div>`;
                    
                    html += `<div class="perf-metric" style="padding: 5px 0;">`;
                    html += `<span class="perf-label">çŠ¶æ€</span>`;
                    html += `<span class="perf-value ${statusClass}">${stats.status.toUpperCase()}</span>`;
                    html += `</div>`;
                    
                    if (stats.compressed_times > 0) {
                        html += `<div style="font-size: 12px; color: #888; margin-top: 5px;">`;
                        html += `ğŸ—ƒï¸ å·²å‹ç¼© ${stats.compressed_times} æ¬¡`;
                        html += `</div>`;
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½ä¸Šä¸‹æ–‡ç›‘æ§å¤±è´¥:', error);
                document.getElementById('context-monitor-content').innerHTML = 
                    '<p style="color: #ef4444; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }
        
        /**
         * å‹ç¼©ä¸Šä¸‹æ–‡
         */
        async function compressContext() {
            const threadId = prompt('è¯·è¾“å…¥è¦å‹ç¼©çš„çº¿ç¨‹IDï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤çº¿ç¨‹ï¼‰:');
            
            try {
                const response = await fetch('/api/context/compress', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        thread_id: threadId || 'default',
                        keep_recent: 10
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`å‹ç¼©æˆåŠŸï¼\nå‹ç¼©å‰: ${data.before_tokens} tokens\nå‹ç¼©å: ${data.after_tokens} tokens\nèŠ‚çœ: ${data.saved_tokens} tokens`);
                    await loadContextMonitor();
                } else {
                    const error = await response.json();
                    alert('å‹ç¼©å¤±è´¥: ' + (error.detail || error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('å‹ç¼©å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * é‡ç½®ä¸Šä¸‹æ–‡
         */
        async function resetContext() {
            const threadId = prompt('è¯·è¾“å…¥è¦é‡ç½®çš„çº¿ç¨‹IDï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤çº¿ç¨‹ï¼‰:');
            
            if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥çº¿ç¨‹çš„ä¸Šä¸‹æ–‡å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å†å²æ¶ˆæ¯ï¼')) {
                return;
            }
            
            try {
                const response = await fetch('/api/context/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        thread_id: threadId || 'default',
                        keep_system_message: true
                    })
                });
                
                if (response.ok) {
                    alert('é‡ç½®æˆåŠŸï¼');
                    await loadContextMonitor();
                } else {
                    const error = await response.json();
                    alert('é‡ç½®å¤±è´¥: ' + (error.detail || error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('é‡ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
         */
        window.onload = async function() {
            console.log('M3 Agent Dashboard v6.0 - åˆå§‹åŒ–ä¸­...');
            
            // é¦–æ¬¡åŠ è½½æ‰€æœ‰æ•°æ®
            await loadAllData();
            await loadMetaPrompts();
            await loadToolUsage();
            await loadFleetStats();
            await loadContextMonitor();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(loadAllData, 30000);
            
            console.log('M3 Agent Dashboard v6.0 - åˆå§‹åŒ–å®Œæˆ');
        };
    </script>
</body>
</html>
