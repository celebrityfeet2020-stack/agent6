<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3 Agent ç®¡ç†é¢æ¿ v2.2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #333; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .status.running { background: #10b981; color: white; }
        .status.error { background: #ef4444; color: white; }
        .model-info { background: #f9fafb; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .model-info p { margin: 5px 0; color: #666; font-size: 14px; }
        .model-info strong { color: #333; }
        .badge { display: inline-block; padding: 3px 10px; background: #3b82f6; color: white; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button:hover { background: #5568d3; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        .tools-list { list-style: none; }
        .tools-list li { padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .tools-list li:last-child { border-bottom: none; }
        .note { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 15px 0; border-radius: 4px; font-size: 14px; }
        
        /* å…ƒæç¤ºè¯ç®¡ç†æ ·å¼ */
        .prompt-item { background: #f9fafb; padding: 15px; border-radius: 8px; margin: 10px 0; border: 2px solid #e5e7eb; }
        .prompt-item.active { border-color: #10b981; background: #ecfdf5; }
        .prompt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .prompt-name { font-weight: 600; color: #333; font-size: 16px; }
        .prompt-actions { display: flex; gap: 8px; }
        .prompt-actions button { padding: 5px 12px; font-size: 12px; }
        .prompt-description { color: #666; font-size: 14px; margin-bottom: 8px; }
        .prompt-preview { background: white; padding: 10px; border-radius: 4px; font-size: 13px; color: #555; max-height: 100px; overflow: hidden; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 50px auto; padding: 30px; border-radius: 10px; max-width: 700px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 24px; color: #333; }
        .close { font-size: 28px; font-weight: bold; color: #999; cursor: pointer; }
        .close:hover { color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .form-group textarea { min-height: 300px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ M3 Agent ç®¡ç†é¢æ¿ v2.2.0</h1>
            <p>å®Œæ•´çš„ Agent ç³»ç»Ÿ | æ”¯æŒå·¥å…·è°ƒç”¨å’Œå¤šè½®å¯¹è¯</p>
        </div>

        <div class="note">
            ğŸ’¡ <strong>æç¤ºï¼š</strong>ç®¡ç†é¢æ¿è‡ªåŠ¨æ£€æµ‹LLMåç«¯ç±»å‹ï¼ˆLM Studio / Ollama / vLLM / OpenAIï¼‰ï¼Œæ”¯æŒä»»æ„OpenAIå…¼å®¹çš„APIã€‚
        </div>

        <div class="grid">
            <!-- LLM åç«¯çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ¤– LLM åç«¯çŠ¶æ€</h2>
                <span class="status running" id="llm-status">è¿è¡Œä¸­</span>
                <span class="badge" id="backend-type">æ£€æµ‹ä¸­...</span>
                <div class="model-info">
                    <p><strong>åç«¯ç±»å‹:</strong> <span id="backend-name">åŠ è½½ä¸­...</span></p>
                    <p><strong>API åœ°å€:</strong> <span id="base-url" style="font-size: 12px;">åŠ è½½ä¸­...</span></p>
                    <p><strong>å½“å‰æ¨¡å‹:</strong> <span id="current-model">åŠ è½½ä¸­...</span></p>
                    <p><strong>å¯ç”¨æ¨¡å‹:</strong> <span id="available-models">åŠ è½½ä¸­...</span></p>
                </div>
                <button onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>

            <!-- Agent API çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ§  Agent API çŠ¶æ€</h2>
                <span class="status running">è¿è¡Œä¸­</span>
                <div class="model-info">
                    <p><strong>é…ç½®æ¨¡å‹:</strong> <span id="agent-model">åŠ è½½ä¸­...</span></p>
                    <p><strong>å·¥å…·æ•°é‡:</strong> <span id="tools-count">åŠ è½½ä¸­...</span></p>
                    <p><strong>API ç«¯å£:</strong> <span id="api-port">åŠ è½½ä¸­...</span></p>
                </div>
            </div>

            <!-- ç³»ç»Ÿæ€§èƒ½ -->
            <div class="card">
                <h2>ğŸ“Š ç³»ç»Ÿæ€§èƒ½</h2>
                <div class="model-info">
                    <p><strong>å“åº”æ—¶é—´:</strong> <span id="response-time">-- ms</span></p>
                    <p><strong>å†…å­˜ä½¿ç”¨:</strong> <span id="memory-usage">-- MB</span></p>
                    <p><strong>è¯·æ±‚æ€»æ•°:</strong> <span id="request-count">--</span></p>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½åŸºå‡†æµ‹è¯• -->
        <div class="card" style="grid-column: 1 / -1;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ æ€§èƒ½åŸºå‡†æµ‹è¯•</h2>
                <button onclick="runBenchmark()" id="benchmark-btn">ğŸš€ å¼€å§‹æµ‹è¯•</button>
            </div>
            <div id="benchmark-results" style="display: none;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6; text-align: left;">
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">æ¨¡å‹</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">çŠ¶æ€</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">å“åº”æ—¶é—´ (ms)</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Tokens/s</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">æ€» Tokens</th>
                        </tr>
                    </thead>
                    <tbody id="benchmark-table-body">
                    </tbody>
                </table>
            </div>
            <div id="benchmark-loading" style="display: none; text-align: center; padding: 20px; color: #666;">
                ğŸ”„ æ­£åœ¨æµ‹è¯•ï¼Œè¯·ç¨å€™...
            </div>
            <div id="benchmark-placeholder" style="text-align: center; padding: 20px; color: #999;">
                ç‚¹å‡»â€œå¼€å§‹æµ‹è¯•â€æŒ‰é’®ï¼Œæ¯”è¾ƒä¸åŒæ¨¡å‹çš„æ€§èƒ½è¡¨ç°
            </div>
        </div>

        <div class="grid">
        </div>

        <!-- å…ƒæç¤ºè¯ç®¡ç† -->
        <div class="card" style="grid-column: 1 / -1;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ“ å…ƒæç¤ºè¯ç®¡ç†</h2>
                <button onclick="showCreatePromptModal()">â• åˆ›å»ºæ–°æç¤ºè¯</button>
            </div>
            <div id="prompts-container">
                <p style="color: #666;">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- å¯ç”¨å·¥å…· (13ä¸ª) -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>ğŸ› ï¸ å¯ç”¨å·¥å…· (13ä¸ª)</h2>
            <ul class="tools-list">
                <li>âœ… <strong>Web Search</strong> - ç½‘é¡µæœç´¢ (DuckDuckGo)</li>
                <li>âœ… <strong>Web Scraper</strong> - ç½‘é¡µæŠ“å– (BeautifulSoup4)</li>
                <li>âœ… <strong>Browser Automation</strong> - æµè§ˆå™¨è‡ªåŠ¨åŒ– (Playwright)</li>
                <li>âœ… <strong>Code Executor</strong> - ä»£ç æ‰§è¡Œ (Dockeræ²™ç›’)</li>
                <li>âœ… <strong>File Operations</strong> - æ–‡ä»¶æ“ä½œ</li>
                <li>âœ… <strong>Image OCR</strong> - å›¾åƒæ–‡å­—è¯†åˆ« (EasyOCR + Tesseract)</li>
                <li>âœ… <strong>Image Analysis</strong> - å›¾åƒåˆ†æ</li>
                <li>âœ… <strong>Data Analysis</strong> - æ•°æ®åˆ†æ (Pandas + Matplotlib)</li>
                <li>âœ… <strong>SSH Tool</strong> - SSH è¿œç¨‹æ‰§è¡Œ</li>
                <li>âœ… <strong>Git Tool</strong> - Git ä»“åº“ç®¡ç†</li>
                <li>âœ… <strong>Universal API</strong> - é€šç”¨ API è°ƒç”¨</li>
                <li>âœ… <strong>Telegram Tool</strong> - Telegram æœºå™¨äºº</li>
                <li>âœ… <strong>Database Query</strong> - æ•°æ®åº“æŸ¥è¯¢</li>
            </ul>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘æç¤ºè¯æ¨¡æ€æ¡† -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">åˆ›å»ºæ–°æç¤ºè¯</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="promptForm">
                <input type="hidden" id="prompt-id">
                <div class="form-group">
                    <label for="prompt-name">åç§°</label>
                    <input type="text" id="prompt-name" required placeholder="ä¾‹å¦‚ï¼šä¸“ä¸šæŠ€æœ¯åŠ©æ‰‹">
                </div>
                <div class="form-group">
                    <label for="prompt-description">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="prompt-description" placeholder="ç®€è¦æè¿°è¿™ä¸ªæç¤ºè¯çš„ç”¨é€”">
                </div>
                <div class="form-group">
                    <label for="prompt-content">æç¤ºè¯å†…å®¹</label>
                    <textarea id="prompt-content" required placeholder="è¾“å…¥å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // æ›´æ–° LLM åç«¯çŠ¶æ€
                document.getElementById('backend-name').textContent = data.llm_backend.type;
                document.getElementById('backend-type').textContent = data.llm_backend.type;
                document.getElementById('base-url').textContent = data.llm_backend.base_url;
                document.getElementById('current-model').textContent = data.llm_backend.current_model;
                document.getElementById('available-models').textContent = data.llm_backend.available_models.join(', ');
                
                // æ›´æ–° Agent API çŠ¶æ€
                document.getElementById('agent-model').textContent = data.agent_api.configured_model;
                document.getElementById('tools-count').textContent = data.agent_api.tools_count;
                document.getElementById('api-port').textContent = data.agent_api.api_port;
            } catch (error) {
                console.error('Failed to load status:', error);
            }
        }

        // åŠ è½½æç¤ºè¯åˆ—è¡¨
        async function loadPrompts() {
            try {
                const response = await fetch('/api/prompts');
                const prompts = await response.json();
                
                const container = document.getElementById('prompts-container');
                if (prompts.length === 0) {
                    container.innerHTML = '<p style="color: #666;">æš‚æ— æç¤ºè¯</p>';
                    return;
                }
                
                container.innerHTML = prompts.map(prompt => `
                    <div class="prompt-item ${prompt.is_active ? 'active' : ''}">
                        <div class="prompt-header">
                            <div>
                                <span class="prompt-name">${prompt.name}</span>
                                ${prompt.is_active ? '<span class="badge" style="background: #10b981;">å½“å‰æ¿€æ´»</span>' : ''}
                            </div>
                            <div class="prompt-actions">
                                ${!prompt.is_active ? `<button class="success" onclick="activatePrompt('${prompt.id}')">âœ“ æ¿€æ´»</button>` : ''}
                                <button onclick="editPrompt('${prompt.id}')">âœï¸ ç¼–è¾‘</button>
                                ${prompt.id !== 'default' ? `<button class="danger" onclick="deletePrompt('${prompt.id}')">ğŸ—‘ï¸ åˆ é™¤</button>` : ''}
                            </div>
                        </div>
                        ${prompt.description ? `<div class="prompt-description">${prompt.description}</div>` : ''}
                        <div class="prompt-preview">${prompt.prompt.substring(0, 200)}...</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load prompts:', error);
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºæç¤ºè¯æ¨¡æ€æ¡†
        function showCreatePromptModal() {
            document.getElementById('modal-title').textContent = 'åˆ›å»ºæ–°æç¤ºè¯';
            document.getElementById('promptForm').reset();
            document.getElementById('prompt-id').value = '';
            document.getElementById('promptModal').style.display = 'block';
        }

        // ç¼–è¾‘æç¤ºè¯
        async function editPrompt(id) {
            try {
                const response = await fetch(`/api/prompts/${id}`);
                const prompt = await response.json();
                
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘æç¤ºè¯';
                document.getElementById('prompt-id').value = prompt.id;
                document.getElementById('prompt-name').value = prompt.name;
                document.getElementById('prompt-description').value = prompt.description || '';
                document.getElementById('prompt-content').value = prompt.prompt;
                document.getElementById('promptModal').style.display = 'block';
            } catch (error) {
                alert('åŠ è½½æç¤ºè¯å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ¿€æ´»æç¤ºè¯
        async function activatePrompt(id) {
            if (!confirm('ç¡®å®šè¦æ¿€æ´»è¿™ä¸ªæç¤ºè¯å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/prompts/${id}/activate`, { method: 'POST' });
                if (response.ok) {
                    alert('æç¤ºè¯å·²æ¿€æ´»ï¼');
                    loadPrompts();
                } else {
                    alert('æ¿€æ´»å¤±è´¥');
                }
            } catch (error) {
                alert('æ¿€æ´»å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ é™¤æç¤ºè¯
        async function deletePrompt(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            try {
                const response = await fetch(`/api/prompts/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('æç¤ºè¯å·²åˆ é™¤');
                    loadPrompts();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('promptModal').style.display = 'none';
        }

        // è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        async function runBenchmark() {
            const btn = document.getElementById('benchmark-btn');
            const loading = document.getElementById('benchmark-loading');
            const placeholder = document.getElementById('benchmark-placeholder');
            const results = document.getElementById('benchmark-results');
            const tbody = document.getElementById('benchmark-table-body');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            placeholder.style.display = 'none';
            results.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/benchmark');
                const data = await response.json();
                
                // æ¸…ç©ºè¡¨æ ¼
                tbody.innerHTML = '';
                
                // å¡«å……æ•°æ®
                data.benchmark_results.forEach(result => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #e5e7eb';
                    
                    if (result.status === 'success') {
                        row.innerHTML = `
                            <td style="padding: 12px;">${result.model}</td>
                            <td style="padding: 12px;"><span class="status running">æˆåŠŸ</span></td>
                            <td style="padding: 12px;">${result.latency_ms}</td>
                            <td style="padding: 12px;">${result.tokens_per_second}</td>
                            <td style="padding: 12px;">${result.total_tokens}</td>
                        `;
                    } else {
                        row.innerHTML = `
                            <td style="padding: 12px;">${result.model}</td>
                            <td style="padding: 12px;"><span class="status error">å¤±è´¥</span></td>
                            <td style="padding: 12px;" colspan="3">${result.error}</td>
                        `;
                    }
                    
                    tbody.appendChild(row);
                });
                
                // æ˜¾ç¤ºç»“æœ
                loading.style.display = 'none';
                results.style.display = 'block';
            } catch (error) {
                alert('æµ‹è¯•å¤±è´¥ï¼š' + error.message);
                loading.style.display = 'none';
                placeholder.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ å¼€å§‹æµ‹è¯•';
            }
        }

        // æäº¤è¡¨å•
        document.getElementById('promptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('prompt-id').value;
            const data = {
                name: document.getElementById('prompt-name').value,
                description: document.getElementById('prompt-description').value,
                prompt: document.getElementById('prompt-content').value
            };
            
            try {
                let response;
                if (id) {
                    // æ›´æ–°
                    response = await fetch(`/api/prompts/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // åˆ›å»º
                    response = await fetch('/api/prompts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    alert(id ? 'æç¤ºè¯å·²æ›´æ–°' : 'æç¤ºè¯å·²åˆ›å»º');
                    closeModal();
                    loadPrompts();
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        });

        // åˆ·æ–°çŠ¶æ€
        function refreshStatus() {
            loadStatus();
            loadPrompts();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = () => {
            loadStatus();
            loadPrompts();
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = (event) => {
            const modal = document.getElementById('promptModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
