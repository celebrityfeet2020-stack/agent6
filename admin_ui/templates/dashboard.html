<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3 Agent ç®¡ç†é¢æ¿ v6.5.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* æ·±è‰²æŠ¤çœ¼ä¸»é¢˜ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #1a1a2e;
            color: #e0e0e0;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        
        /* å¸ƒå±€ */
        .grid-2x2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-3x3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-full { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        
        .card { 
            background: #16213e; 
            border-radius: 10px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid #2a3f5f;
        }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #e0e0e0; }
        
        .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .status.running { background: #10b981; color: white; }
        .status.healthy { background: #10b981; color: white; }
        .status.degraded { background: #f59e0b; color: white; }
        .status.error { background: #ef4444; color: white; }
        
        .model-info { background: #0f1b2e; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #2a3f5f; }
        .model-info p { margin: 5px 0; color: #b0b0b0; font-size: 14px; }
        .model-info strong { color: #e0e0e0; }
        
        .badge { display: inline-block; padding: 3px 10px; background: #3b82f6; color: white; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        
        button { 
            background: #667eea; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            margin: 5px; 
        }
        button:hover { background: #5568d3; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        button.small { padding: 5px 12px; font-size: 12px; }
        
        .tools-list { list-style: none; }
        .tools-list li { padding: 8px 0; border-bottom: 1px solid #2a3f5f; color: #b0b0b0; }
        .tools-list li:last-child { border-bottom: none; }
        
        .note { 
            background: #2a2a1e; 
            border-left: 4px solid #f59e0b; 
            padding: 12px; 
            margin: 15px 0; 
            border-radius: 4px; 
            font-size: 14px; 
            color: #e0e0e0;
        }
        .note.success { background: #1a2e1a; border-left-color: #10b981; }
        .note.info { background: #1a2a3e; border-left-color: #3b82f6; }
        
        /* æ€§èƒ½æŒ‡æ ‡æ ·å¼ */
        .perf-metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #2a3f5f; }
        .perf-metric:last-child { border-bottom: none; }
        .perf-label { color: #b0b0b0; font-size: 14px; }
        .perf-value { color: #e0e0e0; font-size: 16px; font-weight: 600; }
        .perf-value.good { color: #10b981; }
        .perf-value.warning { color: #f59e0b; }
        .perf-value.error { color: #ef4444; }
        .perf-timestamp { color: #808080; font-size: 12px; margin-top: 10px; text-align: right; }
        
        /* å¤§æ•°å­—å¡ç‰‡ */
        .big-number { text-align: center; padding: 20px; }
        .big-number .number { font-size: 48px; font-weight: 700; color: #667eea; margin: 10px 0; }
        .big-number .label { font-size: 14px; color: #b0b0b0; }
        .big-number .sublabel { font-size: 12px; color: #808080; margin-top: 5px; }
        
        /* å…ƒæç¤ºè¯ç®¡ç†æ ·å¼ */
        .prompt-item { background: #0f1b2e; padding: 15px; border-radius: 8px; margin: 10px 0; border: 2px solid #2a3f5f; }
        .prompt-item.active { border-color: #10b981; background: #1a2e1a; }
        .prompt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .prompt-name { font-weight: 600; color: #e0e0e0; font-size: 16px; }
        .prompt-actions { display: flex; gap: 8px; }
        .prompt-actions button { padding: 5px 12px; font-size: 12px; margin: 0; }
        .prompt-description { color: #b0b0b0; font-size: 14px; margin-bottom: 8px; }
        .prompt-preview { background: #16213e; padding: 10px; border-radius: 4px; font-size: 13px; color: #b0b0b0; max-height: 100px; overflow: hidden; border: 1px solid #2a3f5f; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: #16213e; margin: 50px auto; padding: 30px; border-radius: 10px; max-width: 700px; max-height: 80vh; overflow-y: auto; border: 1px solid #2a3f5f; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 24px; color: #e0e0e0; }
        .close { font-size: 28px; font-weight: bold; color: #808080; cursor: pointer; }
        .close:hover { color: #e0e0e0; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #e0e0e0; }
        .form-group input, .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #2a3f5f; 
            border-radius: 6px; 
            font-size: 14px; 
            background: #0f1b2e;
            color: #e0e0e0;
        }
        .form-group textarea { min-height: 300px; font-family: monospace; }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1024px) {
            .grid-3x3 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .grid-2x2, .grid-3x3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ M3 Agent ç®¡ç†é¢æ¿ v6.5.1</h1>
            <p>æ™ºèƒ½å»¶è¿Ÿé¢„åŠ è½½ | å®šæ—¶å¥åº·æ£€æµ‹ | æ€§èƒ½ç›‘æ§ | å…ƒæç¤ºè¯ç®¡ç†</p>
        </div>

        <div class="note success">
            âœ… <strong>v6.5.1 æ–°ç‰¹æ€§ï¼š</strong>å¯åŠ¨å5åˆ†é’ŸåŠ è½½å†…å­˜ | å¯åŠ¨å20åˆ†é’Ÿæ‰§è¡Œæ€§èƒ½æµ‹è¯• | æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡(é”™å¼€15åˆ†é’Ÿ) | æ·±è‰²æŠ¤çœ¼ä¸»é¢˜ | åŒ—äº¬æ—¶é—´æ˜¾ç¤ºä¿®å¤
        </div>

        <!-- ç³»ç»Ÿè¿è¡Œæ—¶é—´ã€å†…å­˜é¢„åŠ è½½ã€æ•´ä½“å¥åº·çŠ¶æ€ -->
        <div class="grid-3x3">
            <div class="card">
                <h2>ç³»ç»Ÿè¿è¡Œæ—¶é—´</h2>
                <div class="big-number">
                    <div class="number" id="uptime">--</div>
                    <div class="label">åŒ…æ‹¬æ—¶é—´</div>
                </div>
            </div>

            <div class="card">
                <h2>å†…å­˜é¢„åŠ è½½</h2>
                <div class="big-number">
                    <div class="number" id="memory-status">â³</div>
                    <div class="label" id="memory-label">ç­‰å¾…ä¸­... (T+<span id="memory-countdown">--</span>ç§’)</div>
                </div>
            </div>

            <div class="card">
                <h2>æ•´ä½“å¥åº·çŠ¶æ€</h2>
                <div class="big-number">
                    <div class="number" id="health-icon">ğŸŸ¢</div>
                    <div class="label" id="health-status">å¥åº·</div>
                </div>
            </div>
        </div>

        <!-- LLMåç«¯çŠ¶æ€ã€Agent APIçŠ¶æ€ -->
        <div class="grid-2x2">
            <div class="card">
                <h2>ğŸ¤– LLMåç«¯çŠ¶æ€</h2>
                <p><span class="status running">è¿è¡Œä¸­</span></p>
                <div class="model-info">
                    <p><strong>APIåœ°å€:</strong> <span id="llm-url">http://192.168.9.125:8000/v1</span></p>
                    <p><strong>å½“å‰æ¨¡å‹:</strong> <span id="llm-model">minimax/minimax-m2</span></p>
                    <p><strong>å¯ç”¨æ¨¡å‹:</strong></p>
                    <div id="available-models" style="max-height: 150px; overflow-y: auto; padding: 10px 0;">
                        <p style="color: #808080;">åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <button onclick="refreshModels()" class="small">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>

            <div class="card">
                <h2>ğŸ¯ Agent APIçŠ¶æ€</h2>
                <p><span class="status running">è¿è¡Œä¸­</span></p>
                <div class="model-info">
                    <p><strong>é…ç½®æ¨¡å‹:</strong> <span id="agent-model">minimax/minimax-m2</span></p>
                    <p><strong>å·¥å…·æ•°é‡:</strong> <span id="tools-count">15</span></p>
                    <p><strong>APIç«¯å£:</strong> 8000</p>
                    <p><strong>æœ€åæ£€æµ‹:</strong> --</p>
                </div>
                <button onclick="testAgent()" class="small">ğŸ§ª ç«‹å³æ£€æµ‹</button>
            </div>
        </div>

        <!-- æ¨¡å‹æ€§èƒ½ã€APIæ€§èƒ½ -->
        <div class="grid-2x2">
            <div class="card">
                <h2>ğŸ“Š æ¨¡å‹æ€§èƒ½</h2>
                <div id="model-performance">
                    <div class="perf-metric">
                        <span class="perf-label">å“åº”æ—¶é—´</span>
                        <span class="perf-value good" id="model-latency">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">ååé‡</span>
                        <span class="perf-value good" id="model-throughput">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">é”™è¯¯ç‡</span>
                        <span class="perf-value good" id="model-error-rate">--</span>
                    </div>
                    <p class="perf-timestamp">æœ€åæµ‹è¯•: <span id="model-perf-time">--</span></p>
                </div>
                <button onclick="runBenchmark()" class="small">â–¶ï¸ å¼€å§‹æµ‹è¯•</button>
            </div>

            <div class="card">
                <h2>ğŸ“ˆ APIæ€§èƒ½</h2>
                <div id="api-performance">
                    <div class="perf-metric">
                        <span class="perf-label">å¹³å‡å“åº”æ—¶é—´</span>
                        <span class="perf-value good" id="api-latency">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">è¯·æ±‚æˆåŠŸç‡</span>
                        <span class="perf-value good" id="api-success-rate">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">æ´»è·ƒè¿æ¥</span>
                        <span class="perf-value" id="api-connections">--</span>
                    </div>
                    <p class="perf-timestamp">æ•°æ®æ›´æ–°: <span id="api-perf-time">--</span></p>
                </div>
            </div>
        </div>

        <!-- å…ƒæç¤ºè¯ç®¡ç† -->
        <div class="grid-full">
            <div class="card">
                <h2>ğŸ“ å…ƒæç¤ºè¯ç®¡ç† <button onclick="showAddPromptModal()" class="small success">â• æ–°å¢</button></h2>
                <div id="prompts-list">
                    <p style="color: #808080;">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- æ–°å¢/ç¼–è¾‘æç¤ºè¯æ¨¡æ€æ¡† -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">æ–°å¢å…ƒæç¤ºè¯</h2>
                <span class="close" onclick="closePromptModal()">&times;</span>
            </div>
            <form id="promptForm" onsubmit="savePrompt(event)">
                <div class="form-group">
                    <label for="prompt-name">åç§°</label>
                    <input type="text" id="prompt-name" required>
                </div>
                <div class="form-group">
                    <label for="prompt-description">æè¿°</label>
                    <input type="text" id="prompt-description" required>
                </div>
                <div class="form-group">
                    <label for="prompt-content">å†…å®¹</label>
                    <textarea id="prompt-content" required></textarea>
                </div>
                <button type="submit" class="success">ğŸ’¾ ä¿å­˜</button>
                <button type="button" onclick="closePromptModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script>
        let editingPromptId = null;
        // v6.5.6: ä»åç«¯è·å–å®¹å™¨å¯åŠ¨æ—¶é—´
        let containerStartTime = null;

        // è·å–åç«¯å¯åŠ¨æ—¶é—´
        async function fetchStartTime() {
            try {
                const response = await fetch('/api/system/uptime');
                const data = await response.json();
                if (data.start_time) {
                    containerStartTime = new Date(data.start_time);
                }
            } catch (error) {
                console.error('è·å–å¯åŠ¨æ—¶é—´å¤±è´¥:', error);
            }
        }

        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateUptime() {
            if (!containerStartTime) {
                document.getElementById('uptime').textContent = '--';
                return;
            }
            const elapsed = Math.floor((Date.now() - containerStartTime.getTime()) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            document.getElementById('uptime').textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // æ›´æ–°å†…å­˜é¢„åŠ è½½çŠ¶æ€
        function updateMemoryStatus() {
            if (!containerStartTime) return;
            const elapsed = Math.floor((Date.now() - containerStartTime.getTime()) / 1000);
            const memoryIcon = document.getElementById('memory-status');
            const memoryLabel = document.getElementById('memory-label');
            const countdown = document.getElementById('memory-countdown');

            if (elapsed < 300) {
                // 5åˆ†é’Ÿå†…
                const remaining = 300 - elapsed;
                memoryIcon.textContent = 'â³';
                memoryLabel.innerHTML = `ç­‰å¾…ä¸­... (T+<span id="memory-countdown">${remaining}</span>ç§’)`;
            } else if (elapsed < 1200) {
                // 5-20åˆ†é’Ÿ
                const remaining = 1200 - elapsed;
                memoryIcon.textContent = 'âœ…';
                memoryLabel.innerHTML = `å·²åŠ è½½ | æ€§èƒ½æµ‹è¯•å€’è®¡æ—¶: ${remaining}ç§’`;
            } else {
                // 20åˆ†é’Ÿå
                memoryIcon.textContent = 'âœ…';
                memoryLabel.textContent = 'å·²åŠ è½½ | å®šæœŸæµ‹è¯•ä¸­';
            }
        }

        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        async function refreshModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                const modelsDiv = document.getElementById('available-models');
                modelsDiv.innerHTML = data.models.map(m => `<p style="color: #b0b0b0;">â€¢ ${m}</p>`).join('');
            } catch (error) {
                console.error('Failed to fetch models:', error);
            }
        }

        // æµ‹è¯•Agent
        async function testAgent() {
            alert('Agentæµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // è¿è¡ŒåŸºå‡†æµ‹è¯•
        async function runBenchmark() {
            if (!confirm('æ€§èƒ½æµ‹è¯•å°†å ç”¨èµ„æºçº¦30ç§’,æ˜¯å¦ç»§ç»­?')) return;
            
            try {
                const response = await fetch('/api/benchmark');
                const data = await response.json();
                alert(`æµ‹è¯•å®Œæˆ!\\nå“åº”æ—¶é—´: ${data.latency}ms\\nååé‡: ${data.throughput} tokens/s`);
            } catch (error) {
                alert('æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æç¤ºè¯åˆ—è¡¨
        async function loadPrompts() {
            try {
                const response = await fetch('/api/prompts');
                const data = await response.json();
                const promptsList = document.getElementById('prompts-list');
                
                if (data.prompts.length === 0) {
                    promptsList.innerHTML = '<p style="color: #808080;">æš‚æ— æç¤ºè¯</p>';
                    return;
                }

                promptsList.innerHTML = data.prompts.map(p => `
                    <div class="prompt-item ${p.is_active ? 'active' : ''}">
                        <div class="prompt-header">
                            <span class="prompt-name">${p.name} ${p.is_active ? '<span class="badge">æ¿€æ´»ä¸­</span>' : ''}</span>
                            <div class="prompt-actions">
                                ${!p.is_active ? `<button onclick="activatePrompt('${p.id}')" class="small success">æ¿€æ´»</button>` : ''}
                                <button onclick="editPrompt('${p.id}')" class="small">ç¼–è¾‘</button>
                                ${!p.is_default ? `<button onclick="deletePrompt('${p.id}')" class="small danger">åˆ é™¤</button>` : ''}
                            </div>
                        </div>
                        <div class="prompt-description">${p.description}</div>
                        <div class="prompt-preview">${p.content.substring(0, 100)}...</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load prompts:', error);
            }
        }

        // æ˜¾ç¤ºæ–°å¢æç¤ºè¯æ¨¡æ€æ¡†
        function showAddPromptModal() {
            editingPromptId = null;
            document.getElementById('modal-title').textContent = 'æ–°å¢å…ƒæç¤ºè¯';
            document.getElementById('promptForm').reset();
            document.getElementById('promptModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closePromptModal() {
            document.getElementById('promptModal').style.display = 'none';
        }

        // ä¿å­˜æç¤ºè¯
        async function savePrompt(event) {
            event.preventDefault();
            
            const data = {
                name: document.getElementById('prompt-name').value,
                description: document.getElementById('prompt-description').value,
                content: document.getElementById('prompt-content').value
            };

            try {
                const url = editingPromptId ? `/api/prompts/${editingPromptId}` : '/api/prompts';
                const method = editingPromptId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closePromptModal();
                    loadPrompts();
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘æç¤ºè¯
        async function editPrompt(id) {
            try {
                const response = await fetch(`/api/prompts/${id}`);
                const prompt = await response.json();
                
                editingPromptId = id;
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘å…ƒæç¤ºè¯';
                document.getElementById('prompt-name').value = prompt.name;
                document.getElementById('prompt-description').value = prompt.description;
                document.getElementById('prompt-content').value = prompt.content;
                document.getElementById('promptModal').style.display = 'block';
            } catch (error) {
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ¿€æ´»æç¤ºè¯
        async function activatePrompt(id) {
            try {
                const response = await fetch(`/api/prompts/${id}/activate`, {method: 'POST'});
                if (response.ok) {
                    loadPrompts();
                } else {
                    alert('æ¿€æ´»å¤±è´¥');
                }
            } catch (error) {
                alert('æ¿€æ´»å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤æç¤ºè¯
        async function deletePrompt(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æç¤ºè¯å—?')) return;
            
            try {
                const response = await fetch(`/api/prompts/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    loadPrompts();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // v6.5.6: åˆå§‹åŒ– - å…ˆè·å–åç«¯å¯åŠ¨æ—¶é—´
        fetchStartTime().then(() => {
            setInterval(updateUptime, 1000);
            setInterval(updateMemoryStatus, 1000);
            updateUptime();
            updateMemoryStatus();
        });
        refreshModels();
        loadPrompts();
    </script>
</body>
</html>
