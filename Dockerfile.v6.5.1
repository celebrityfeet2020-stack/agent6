# M3 Agent v6.5.1 - Production Ready Dockerfile
# 基于v6.4稳定版本,添加清华镜像源和非交互式安装

FROM mcr.microsoft.com/playwright/python:v1.49.1-jammy

# 设置环境变量避免交互式安装
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
ENV PYTHONUNBUFFERED=1

# 安装系统依赖 (完全非交互式)
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    tzdata \
    tesseract-ocr \
    tesseract-ocr-chi-sim \
    tesseract-ocr-eng \
    libtesseract-dev \
    poppler-utils \
    ffmpeg \
    redis-tools \
    curl \
    jq && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 配置pip使用清华镜像源 (避免超时)
RUN pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip3 config set global.timeout 300

# 复制requirements.txt并安装依赖
COPY backend/requirements.txt ./
RUN pip3 install --no-cache-dir --upgrade pip && \
    pip3 install --no-cache-dir -r requirements.txt

# 复制后端代码
COPY backend/ ./backend/
COPY config/ ./config/
COPY admin_ui/ ./admin_ui/

# 验证关键文件存在
RUN echo "=== Verifying critical files ===" && \
    ls -lh /app/backend/chatroom_api.py && \
    ls -lh /app/backend/admin_app.py && \
    ls -lh /app/backend/app/core/background_tasks.py && \
    ls -lh /app/backend/app/core/state_manager.py && \
    echo "=== All critical files present ===" || \
    (echo "ERROR: Missing critical files!" && exit 1)

# 安装 Playwright 浏览器
RUN playwright install chromium

# Whisper模型将在首次使用时自动下载

# 创建必要的目录
RUN mkdir -p /app/logs /app/data /app/uploads

# 暴露端口
EXPOSE 8888 8889

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8889/health || exit 1

# 启动脚本
COPY <<'EOF' /app/start.sh
#!/bin/bash
set -e

echo "=== M3 Agent v6.5.1 Starting ==="
echo "Time: $(date)"
echo "Timezone: $TZ"

cd /app/backend

# 启动main.py (Agent API on port 8888)
echo "Starting Agent API on port 8888..."
python3 main.py &
MAIN_PID=$!

# 等待main.py启动
sleep 5

# 启动admin_app.py (管理面板 on port 8889)
echo "Starting Admin Panel on port 8889..."
python3 admin_app.py &
ADMIN_PID=$!

echo "=== M3 Agent v6.5.1 Started ==="
echo "Agent API: http://localhost:8888"
echo "Admin Panel: http://localhost:8889"
echo "Chatroom: http://localhost:8889/chatroom/"

# 等待进程
wait $MAIN_PID $ADMIN_PID

EOF

RUN chmod +x /app/start.sh

# 启动
CMD ["/app/start.sh"]
