<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3 Agent ç®¡ç†é¢æ¿ v5.5</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        
        /* 2-2-2å¸ƒå±€ */
        .grid-2x2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-full { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #333; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .status.running { background: #10b981; color: white; }
        .status.error { background: #ef4444; color: white; }
        .model-info { background: #f9fafb; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .model-info p { margin: 5px 0; color: #666; font-size: 14px; }
        .model-info strong { color: #333; }
        .badge { display: inline-block; padding: 3px 10px; background: #3b82f6; color: white; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button:hover { background: #5568d3; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        .tools-list { list-style: none; }
        .tools-list li { padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .tools-list li:last-child { border-bottom: none; }
        .note { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 15px 0; border-radius: 4px; font-size: 14px; }
        
        /* æ€§èƒ½æŒ‡æ ‡æ ·å¼ */
        .perf-metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .perf-metric:last-child { border-bottom: none; }
        .perf-label { color: #666; font-size: 14px; }
        .perf-value { color: #333; font-size: 16px; font-weight: 600; }
        .perf-value.good { color: #10b981; }
        .perf-value.warning { color: #f59e0b; }
        .perf-value.error { color: #ef4444; }
        .perf-timestamp { color: #999; font-size: 12px; margin-top: 10px; text-align: right; }
        
        /* å…ƒæç¤ºè¯ç®¡ç†æ ·å¼ */
        .prompt-item { background: #f9fafb; padding: 15px; border-radius: 8px; margin: 10px 0; border: 2px solid #e5e7eb; }
        .prompt-item.active { border-color: #10b981; background: #ecfdf5; }
        .prompt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .prompt-name { font-weight: 600; color: #333; font-size: 16px; }
        .prompt-actions { display: flex; gap: 8px; }
        .prompt-actions button { padding: 5px 12px; font-size: 12px; }
        .prompt-description { color: #666; font-size: 14px; margin-bottom: 8px; }
        .prompt-preview { background: white; padding: 10px; border-radius: 4px; font-size: 13px; color: #555; max-height: 100px; overflow: hidden; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 50px auto; padding: 30px; border-radius: 10px; max-width: 700px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 24px; color: #333; }
        .close { font-size: 28px; font-weight: bold; color: #999; cursor: pointer; }
        .close:hover { color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .form-group textarea { min-height: 300px; font-family: monospace; }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .grid-2x2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ M3 Agent ç®¡ç†é¢æ¿ v5.5</h1>
            <p>å®Œæ•´çš„ Agent ç³»ç»Ÿ | æ”¯æŒå¤šç§LLMæ¡†æ¶ | å®æ—¶æ€§èƒ½ç›‘æ§</p>
        </div>

        <div class="note">
            ğŸ’¡ <strong>v5.5æ›´æ–°ï¼š</strong>ç®€åŒ–åç«¯æ£€æµ‹é€»è¾‘ | ä¿®å¤ç‰ˆæœ¬å·æ˜¾ç¤º | ä¼˜åŒ–å‰åç«¯è”é€š | ä¿®å¤LangGraph APIé—®é¢˜
        </div>

        <!-- ç¬¬ä¸€è¡Œï¼šLLMåç«¯çŠ¶æ€ + Agent APIçŠ¶æ€ -->
        <div class="grid-2x2">
            <!-- LLM åç«¯çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ¤– LLM åç«¯çŠ¶æ€</h2>
                <span class="status running" id="llm-status">è¿è¡Œä¸­</span>
                <div class="model-info">
                    <p><strong>API åœ°å€:</strong> <span id="base-url" style="font-size: 12px;">åŠ è½½ä¸­...</span></p>
                    <p><strong>å½“å‰æ¨¡å‹:</strong> <span id="current-model">åŠ è½½ä¸­...</span></p>
                    <p><strong>å¯ç”¨æ¨¡å‹:</strong></p>
                    <ul id="available-models" class="tools-list" style="max-height: 150px; overflow-y: auto;">
                        <li>åŠ è½½ä¸­...</li>
                    </ul>
                </div>
                <button onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>

            <!-- Agent API çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ§  Agent API çŠ¶æ€</h2>
                <span class="status running">è¿è¡Œä¸­</span>
                <div class="model-info">
                    <p><strong>é…ç½®æ¨¡å‹:</strong> <span id="agent-model">åŠ è½½ä¸­...</span></p>
                    <p><strong>å·¥å…·æ•°é‡:</strong> <span id="tools-count">åŠ è½½ä¸­...</span></p>
                    <p><strong>API ç«¯å£:</strong> <span id="api-port">åŠ è½½ä¸­...</span></p>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šæ¨¡å‹æ€§èƒ½ + APIæ€§èƒ½ -->
        <div class="grid-2x2">
            <!-- æ¨¡å‹æ€§èƒ½ -->
            <div class="card">
                <h2>âš¡ æ¨¡å‹æ€§èƒ½</h2>
                <div class="model-info">
                    <div class="perf-metric">
                        <span class="perf-label">Tokens/sï¼ˆååé‡ï¼‰</span>
                        <span class="perf-value good" id="tokens-per-second">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">TTFTï¼ˆé¦–tokenå»¶è¿Ÿï¼‰</span>
                        <span class="perf-value" id="ttft">-- ms</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">å¹³å‡å»¶è¿Ÿ</span>
                        <span class="perf-value" id="avg-latency">-- ms</span>
                    </div>
                    <div class="perf-timestamp" id="model-perf-updated">--</div>
                </div>
            </div>

            <!-- API æ€§èƒ½ -->
            <div class="card">
                <h2>ğŸ“Š API æ€§èƒ½</h2>
                <div class="model-info">
                    <div class="perf-metric">
                        <span class="perf-label">å¹³å‡å“åº”æ—¶é—´</span>
                        <span class="perf-value" id="api-response-time">-- ms</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">è¯·æ±‚æ€»æ•°</span>
                        <span class="perf-value" id="total-requests">--</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">æˆåŠŸç‡</span>
                        <span class="perf-value good" id="success-rate">--%</span>
                    </div>
                    <div class="perf-metric">
                        <span class="perf-label">æ¯å°æ—¶è¯·æ±‚æ•°</span>
                        <span class="perf-value" id="requests-per-hour">--</span>
                    </div>
                    <div class="perf-timestamp" id="api-perf-updated">--</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šå…ƒæç¤ºè¯ç®¡ç†ï¼ˆå æ»¡å®½åº¦ï¼‰ -->
        <div class="grid-full">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ“ å…ƒæç¤ºè¯ç®¡ç†</h2>
                    <button onclick="showCreatePromptModal()">â• åˆ›å»ºæ–°æç¤ºè¯</button>
                </div>
                <div id="prompts-container">
                    <p style="color: #666;">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ç¬¬å››è¡Œï¼šå¯ç”¨å·¥å…·ï¼ˆå æ»¡å®½åº¦ï¼‰ -->
        <div class="grid-full">
            <div class="card">
                <h2>ğŸ› ï¸ å¯ç”¨å·¥å…· (<span id="tools-count-display">15</span>ä¸ª)</h2>
                <ul class="tools-list">
                    <li>âœ… <strong>Web Search</strong> - ç½‘é¡µæœç´¢ (DuckDuckGo)</li>
                    <li>âœ… <strong>Web Scraper</strong> - ç½‘é¡µæŠ“å– (BeautifulSoup4)</li>
                    <li>âœ… <strong>Browser Automation</strong> - æµè§ˆå™¨è‡ªåŠ¨åŒ– (Playwright)</li>
                    <li>âœ… <strong>Code Executor</strong> - ä»£ç æ‰§è¡Œ (Dockeræ²™ç›’)</li>
                    <li>âœ… <strong>File Operations</strong> - æ–‡ä»¶æ“ä½œ</li>
                    <li>âœ… <strong>Image OCR</strong> - å›¾åƒæ–‡å­—è¯†åˆ« (EasyOCR + Tesseract)</li>
                    <li>âœ… <strong>Image Analysis</strong> - å›¾åƒåˆ†æ</li>
                    <li>âœ… <strong>Data Analysis</strong> - æ•°æ®åˆ†æ (Pandas + Matplotlib)</li>
                    <li>âœ… <strong>SSH Tool</strong> - SSH è¿œç¨‹æ‰§è¡Œ</li>
                    <li>âœ… <strong>Git Tool</strong> - Git ä»“åº“ç®¡ç†</li>
                    <li>âœ… <strong>Universal API</strong> - é€šç”¨ API è°ƒç”¨</li>
                    <li>âœ… <strong>Telegram Tool</strong> - Telegram æœºå™¨äºº</li>
                    <li>âœ… <strong>Database Query</strong> - æ•°æ®åº“æŸ¥è¯¢</li>
                    <li>âœ… <strong>Email Tool</strong> - é‚®ä»¶å‘é€</li>
                    <li>âœ… <strong>Weather Tool</strong> - å¤©æ°”æŸ¥è¯¢</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘æç¤ºè¯æ¨¡æ€æ¡† -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">åˆ›å»ºæ–°æç¤ºè¯</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="promptForm">
                <input type="hidden" id="prompt-id">
                <div class="form-group">
                    <label for="prompt-name">åç§°</label>
                    <input type="text" id="prompt-name" required placeholder="ä¾‹å¦‚ï¼šä¸“ä¸šæŠ€æœ¯åŠ©æ‰‹">
                </div>
                <div class="form-group">
                    <label for="prompt-description">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="prompt-description" placeholder="ç®€è¦æè¿°è¿™ä¸ªæç¤ºè¯çš„ç”¨é€”">
                </div>
                <div class="form-group">
                    <label for="prompt-content">æç¤ºè¯å†…å®¹</label>
                    <textarea id="prompt-content" required placeholder="è¾“å…¥å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // æ›´æ–° LLM åç«¯çŠ¶æ€
                document.getElementById('base-url').textContent = data.llm_backend.base_url;
                document.getElementById('current-model').textContent = data.llm_backend.current_model;
                
                // æ›´æ–°å¯ç”¨æ¨¡å‹åˆ—è¡¨
                const modelsUl = document.getElementById('available-models');
                if (data.llm_backend.available_models && data.llm_backend.available_models.length > 0) {
                    modelsUl.innerHTML = data.llm_backend.available_models.map(model => `<li>${model}</li>`).join('');
                } else {
                    modelsUl.innerHTML = '<li>æ— å¯ç”¨æ¨¡å‹</li>';
                }
                
                // æ›´æ–° Agent API çŠ¶æ€
                document.getElementById('agent-model').textContent = data.agent_api.configured_model;
                document.getElementById('tools-count').textContent = data.agent_api.tools_count;
                document.getElementById('tools-count-display').textContent = data.agent_api.tools_count;
                document.getElementById('api-port').textContent = data.agent_api.api_port;
                
                // æ›´æ–°æ¨¡å‹æ€§èƒ½
                if (data.model_performance) {
                    const mp = data.model_performance;
                    document.getElementById('tokens-per-second').textContent = mp.tokens_per_second || '--';
                    document.getElementById('ttft').textContent = mp.time_to_first_token_ms ? `${mp.time_to_first_token_ms} ms` : '-- ms';
                    document.getElementById('avg-latency').textContent = mp.average_latency_ms ? `${mp.average_latency_ms} ms` : '-- ms';
                    
                    if (mp.last_updated) {
                        const updateTime = new Date(mp.last_updated).toLocaleString('zh-CN');
                        document.getElementById('model-perf-updated').textContent = `æ›´æ–°æ—¶é—´: ${updateTime}`;
                    }
                }
                
                // æ›´æ–°APIæ€§èƒ½
                if (data.api_performance) {
                    const ap = data.api_performance;
                    document.getElementById('api-response-time').textContent = ap.average_response_time_ms ? `${ap.average_response_time_ms} ms` : '-- ms';
                    document.getElementById('total-requests').textContent = ap.total_requests || '--';
                    document.getElementById('success-rate').textContent = ap.success_rate ? `${ap.success_rate}%` : '--%';
                    document.getElementById('requests-per-hour').textContent = ap.requests_per_hour || '--';
                    
                    if (ap.last_updated) {
                        const updateTime = new Date(ap.last_updated).toLocaleString('zh-CN');
                        document.getElementById('api-perf-updated').textContent = `æ›´æ–°æ—¶é—´: ${updateTime}`;
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            await loadStatus();
            alert('çŠ¶æ€å·²åˆ·æ–°ï¼');
        }

        // åŠ è½½æç¤ºè¯åˆ—è¡¨
        async function loadPrompts() {
            try {
                const response = await fetch('/api/prompts');
                const prompts = await response.json();
                
                const container = document.getElementById('prompts-container');
                if (prompts.length === 0) {
                    container.innerHTML = '<p style="color: #999;">æš‚æ— æç¤ºè¯</p>';
                    return;
                }
                
                container.innerHTML = prompts.map(prompt => `
                    <div class="prompt-item ${prompt.is_active ? 'active' : ''}">
                        <div class="prompt-header">
                            <span class="prompt-name">
                                ${prompt.name}
                                ${prompt.is_active ? '<span class="badge" style="background: #10b981;">å½“å‰ä½¿ç”¨</span>' : ''}
                            </span>
                            <div class="prompt-actions">
                                ${!prompt.is_active ? `<button class="success" onclick="activatePrompt('${prompt.id}')">æ¿€æ´»</button>` : ''}
                                <button onclick="editPrompt('${prompt.id}')">ç¼–è¾‘</button>
                                ${prompt.id !== 'default' ? `<button class="danger" onclick="deletePrompt('${prompt.id}')">åˆ é™¤</button>` : ''}
                            </div>
                        </div>
                        ${prompt.description ? `<div class="prompt-description">${prompt.description}</div>` : ''}
                        <div class="prompt-preview">${prompt.prompt.substring(0, 200)}...</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æç¤ºè¯å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºæç¤ºè¯æ¨¡æ€æ¡†
        function showCreatePromptModal() {
            document.getElementById('modal-title').textContent = 'åˆ›å»ºæ–°æç¤ºè¯';
            document.getElementById('promptForm').reset();
            document.getElementById('prompt-id').value = '';
            document.getElementById('promptModal').style.display = 'block';
        }

        // ç¼–è¾‘æç¤ºè¯
        async function editPrompt(id) {
            try {
                const response = await fetch(`/api/prompts/${id}`);
                const prompt = await response.json();
                
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘æç¤ºè¯';
                document.getElementById('prompt-id').value = prompt.id;
                document.getElementById('prompt-name').value = prompt.name;
                document.getElementById('prompt-description').value = prompt.description || '';
                document.getElementById('prompt-content').value = prompt.prompt;
                document.getElementById('promptModal').style.display = 'block';
            } catch (error) {
                alert('åŠ è½½æç¤ºè¯å¤±è´¥');
            }
        }

        // æ¿€æ´»æç¤ºè¯
        async function activatePrompt(id) {
            try {
                await fetch(`/api/prompts/${id}/activate`, { method: 'POST' });
                await loadPrompts();
                alert('æç¤ºè¯å·²æ¿€æ´»ï¼');
            } catch (error) {
                alert('æ¿€æ´»å¤±è´¥');
            }
        }

        // åˆ é™¤æç¤ºè¯
        async function deletePrompt(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯å—ï¼Ÿ')) return;
            
            try {
                await fetch(`/api/prompts/${id}`, { method: 'DELETE' });
                await loadPrompts();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('promptModal').style.display = 'none';
        }

        // æäº¤è¡¨å•
        document.getElementById('promptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('prompt-id').value;
            const data = {
                name: document.getElementById('prompt-name').value,
                description: document.getElementById('prompt-description').value,
                prompt: document.getElementById('prompt-content').value
            };
            
            try {
                if (id) {
                    // æ›´æ–°
                    await fetch(`/api/prompts/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // åˆ›å»º
                    await fetch('/api/prompts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                closeModal();
                await loadPrompts();
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥');
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('promptModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            await loadStatus();
            await loadPrompts();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
            setInterval(loadStatus, 30000);
        };
    </script>
</body>
</html>
